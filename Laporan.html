<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan & Analitik | Sistem Tagihan</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Load Chart.js (Untuk Grafik Modul E) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Load Litepicker (Untuk Filter Tanggal Modul E) -->
    <script src="https://cdn.jsdelivr.net/npm/litepicker@2.0.12/dist/litepicker.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker@2.0.12/dist/css/litepicker.css"/>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Transisi untuk modal */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal.visible {
            opacity: 1;
            visibility: visible;
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* slate-400 */
            border-radius: 3px;
        }
        .sidebar-link:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .sidebar-link.active {
            background-color: #4f46e5; /* indigo-600 */
            font-weight: 600;
        }
        /* Kustomisasi Litepicker */
        .litepicker {
            z-index: 50 !important;
        }
    </style>
</head>
<body class="flex h-screen">

    <!-- Sidebar (Navigasi Utama) -->
    <aside class="w-64 bg-gray-900 text-white flex flex-col shadow-lg">
        <div class="p-6 text-2xl font-bold border-b border-gray-700">
            SISTEM TAGIHAN
        </div>
        <nav class="flex-1 p-4 space-y-2 custom-scrollbar overflow-y-auto">
            <a href="Main_Dasboard.html" onclick="navigate('Dashboard')" class="sidebar-link flex items-center p-3 rounded-lg transition duration-200">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                Dashboard
            </a>
            <a href="Debitur_manajemen.html" onclick="navigate('Debitur')" class="sidebar-link flex items-center p-3 rounded-lg transition duration-200">
                <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                Manajemen Debitur
            </a>
            <a href="Tagihan_manjemen.html" onclick="navigate('Tagihan')" class="sidebar-link flex items-center p-3 rounded-lg transition duration-200">
                <i data-lucide="receipt" class="w-5 h-5 mr-3"></i>
                Manajemen Tagihan
            </a>
            <a href="Janji_bayar.html" onclick="navigate('JanjiBayar')" class="sidebar-link flex items-center p-3 rounded-lg transition duration-200">
                <i data-lucide="calendar-check" class="w-5 h-5 mr-3"></i>
                Janji Bayar
            </a>
            <a href="pengingat_otomatis.html" onclick="navigate('Reminder')" class="sidebar-link flex items-center p-3 rounded-lg transition duration-200">
                <i data-lucide="send" class="w-5 h-5 mr-3"></i>
                Template Reminder
            </a>
            <a href="pembayaran.html" onclick="navigate('Pembayaran')" class="sidebar-link flex items-center p-3 rounded-lg transition duration-200">
                <i data-lucide="credit-card" class="w-5 h-5 mr-3"></i>
                Manajemen Pembayaran
            </a>
            <a href="Laporan.html" class="sidebar-link active flex items-center p-3 rounded-lg transition duration-200">
                <i data-lucide="area-chart" class="w-5 h-5 mr-3"></i>
                Laporan & Analitik
            </a>
            <a href="pengaturan.html" onclick="navigate('Keamanan')" class="sidebar-link flex items-center p-3 rounded-lg transition duration-200">
                <i data-lucide="shield" class="w-5 h-5 mr-3"></i>
                Keamanan & Role
            </a>
        </nav>
        <div class="p-4 border-t border-gray-700 text-center text-xs text-gray-400">
            Â© 2025 Sistem Penagihan
        </div>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        
        <!-- Top Header Bar -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Laporan & Analitik (Modul E)</h1>
            <div class="flex items-center space-x-4">
                <span class="text-gray-600 hidden sm:inline">Halo, Admin!</span>
                <button class="text-gray-500 hover:text-indigo-600">
                    <i data-lucide="bell" class="w-6 h-6"></i>
                </button>
            </div>
        </header>

        <!-- Content Area with Scroll -->
        <main class="flex-1 overflow-y-auto p-6 md:p-8">

            <!-- Filter Bar (Sesuai Modul E) -->
            <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <!-- Filter Tanggal (Harian/Mingguan) -->
                    <div class="lg:col-span-2">
                        <label for="date-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter Tanggal</label>
                        <input id="date-filter" placeholder="Pilih rentang tanggal..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <!-- Filter Status -->
                    <div>
                        <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">Filter Status</label>
                        <select id="filter-status" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 h-[42px]">
                            <option value="semua">Semua Status</option>
                            <option value="paid">Paid</option>
                            <option value="unpaid">Unpaid</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                    <!-- Filter Petugas -->
                    <div>
                        <label for="filter-petugas" class="block text-sm font-medium text-gray-700 mb-1">Filter Petugas</label>
                        <select id="filter-petugas" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 h-[42px]">
                            <option value="semua">Semua Petugas</option>
                            <option value="admin">Admin</option>
                            <option value="petugas_a">Petugas A</option>
                            <option value="petugas_b">Petugas B</option>
                        </select>
                    </div>
                    <!-- Tombol Terapkan & Ekspor -->
                    <div class="flex items-end space-x-2">
                        <button id="filter-button" class="w-full h-[42px] bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg font-semibold transition shadow-lg shadow-indigo-500/50 flex items-center justify-center">
                            <i data-lucide="filter" class="w-5 h-5 mr-2"></i> Terapkan
                        </button>
                        <button id="export-csv" class="h-[42px] w-auto bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg font-semibold transition" title="Ekspor CSV (Modul E)">
                            <i data-lucide="file-spreadsheet" class="w-5 h-5"></i>
                        </button>
                        <button id="export-pdf" class="h-[42px] w-auto bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg font-semibold transition" title="Ekspor PDF (Modul E)">
                            <i data-lucide="file-text" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- KPI Cards (Sesuai Modul E) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- KPI 1: Tagihan Terkirim -->
                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-500">Tagihan Terkirim</span>
                        <i data-lucide="send" class="w-5 h-5 text-gray-400"></i>
                    </div>
                    <p id="kpi-terkirim" class="text-3xl font-bold text-gray-900 mt-2">Memuat...</p>
                    <p id="kpi-terkirim-comp" class="text-xs text-gray-500 mt-1">+0% vs periode lalu</p>
                </div>
                <!-- KPI 2: Tagihan Dibayar -->
                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-500">Tagihan Dibayar</span>
                        <i data-lucide="check-check" class="w-5 h-5 text-gray-400"></i>
                    </div>
                    <p id="kpi-dibayar" class="text-3xl font-bold text-gray-900 mt-2">Memuat...</p>
                    <p id="kpi-dibayar-comp" class="text-xs text-gray-500 mt-1">+0% vs periode lalu</p>
                </div>
                <!-- KPI 3: Recovery Rate -->
                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-indigo-500">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-500">Recovery Rate (%)</span>
                        <i data-lucide="trending-up" class="w-5 h-5 text-gray-400"></i>
                    </div>
                    <p id="kpi-recovery" class="text-3xl font-bold text-gray-900 mt-2">Memuat...</p>
                    <p id="kpi-recovery-comp" class="text-xs text-gray-500 mt-1">+0% vs periode lalu</p>
                </div>
                <!-- KPI 4: Contact Rate -->
                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-500">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-500">Contact Rate (%)</span>
                        <i data-lucide="message-circle" class="w-5 h-5 text-gray-400"></i>
                    </div>
                    <p id="kpi-contact" class="text-3xl font-bold text-gray-900 mt-2">Memuat...</p>
                    <p id="kpi-contact-comp" class="text-xs text-gray-500 mt-1">+0% vs periode lalu</p>
                </div>
            </div>

            <!-- Grafik Tren Pembayaran (Sesuai Modul E) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Grafik Tren Pembayaran</h3>
                    <div class="h-80">
                        <canvas id="payment-trend-chart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Efektivitas Kontak</h3>
                    <div class="h-80">
                        <canvas id="contact-rate-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Laporan Harian/Mingguan (Sesuai Modul E) -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <h3 class="text-xl font-bold text-gray-800 p-6">Laporan Harian (Detail)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tanggal</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tagihan Terkirim</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tagihan Dibayar</th>
                                <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Nominal Dibayar</th>
                                <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Recovery Rate</th>
                            </tr>
                        </thead>
                        <tbody id="daily-report-body" class="bg-white divide-y divide-gray-200">
                            <!-- JS akan mengisi data laporan harian di sini -->
                            <tr>
                                <td colspan="5" class="p-8 text-center text-gray-500">
                                    Memuat data laporan... Terapkan filter untuk melihat data.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal Alert (Info/Notifikasi) -->
    <div id="alert-modal" class="modal hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-transform scale-95" onclick="event.stopPropagation()">
            <div class="p-6 text-center">
                <i id="alert-icon" data-lucide="info" class="w-16 h-16 text-blue-500 mx-auto mb-4"></i>
                <h3 id="alert-title" class="text-2xl font-bold text-gray-800">Notifikasi</h3>
                <p id="alert-message" class="text-gray-600 my-4">Pesan notifikasi.</p>
                <div class="flex justify-center">
                    <button type="button" onclick="closeAlert()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- ================== SCRIPT JS ================== -->
    <script>
        // --- DATA & STATE ---
        let paymentTrendChart;
        let contactRateChart;
        
        // --- DOM Elements ---
        const alertModal = document.getElementById('alert-modal');
        const dailyReportBody = document.getElementById('daily-report-body');

        // --- Inisialisasi ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // Inisialisasi Filter Tanggal (Modul E)
            const picker = new Litepicker({
                element: document.getElementById('date-filter'),
                singleMode: false,
                format: 'DD MMM YYYY',
                tooltipText: {
                    one: 'hari',
                    other: 'hari'
                },
                buttonText: {
                    previousMonth: `<i data-lucide="chevron-left"></i>`,
                    nextMonth: `<i data-lucide="chevron-right"></i>`,
                    reset: `<i data-lucide="rotate-ccw"></i>`,
                    apply: 'Terapkan',
                    cancel: 'Batal'
                },
                setup: (picker) => {
                    picker.on('show', () => {
                        lucide.createIcons();
                    });
                }
            });

            // Inisialisasi Grafik (Modul E)
            renderPaymentTrendChart();
            renderContactRateChart();
            
            // Muat data awal (atau data default jika belum ada filter)
            fetchAnalyticsData();
            
            // Attach Listeners
            document.getElementById('filter-button').addEventListener('click', fetchAnalyticsData);
            document.getElementById('export-csv').addEventListener('click', () => {
                showAlert('Simulasi Ekspor (Modul E)', 'Sistem akan men-generate file CSV berdasarkan filter yang Anda pilih.', 'success');
            });
            document.getElementById('export-pdf').addEventListener('click', () => {
                showAlert('Simulasi Ekspor (Modul E)', 'Sistem akan men-generate file PDF berdasarkan filter yang Anda pilih.', 'success');
            });

        });

        // --- FUNGSI UTAMA (Simulasi Pengambilan Data) ---
        function fetchAnalyticsData() {
            // 1. Tampilkan notifikasi loading (simulasi)
            showAlert('Memuat Data', 'Mengambil data analitik berdasarkan filter Anda...', 'info');
            
            // 2. Simulasi Data KPI (Modul E)
            const kpi = {
                terkirim: Math.floor(Math.random() * 200) + 100,
                dibayar: Math.floor(Math.random() * 80) + 50,
                recovery: 0,
                contact: Math.floor(Math.random() * 30) + 50,
            };
            kpi.recovery = Math.round((kpi.dibayar / kpi.terkirim) * 100);
            
            document.getElementById('kpi-terkirim').textContent = kpi.terkirim;
            document.getElementById('kpi-dibayar').textContent = kpi.dibayar;
            document.getElementById('kpi-recovery').textContent = kpi.recovery + '%';
            document.getElementById('kpi-contact').textContent = kpi.contact + '%';
            
            // Update perbandingan (dummy)
            document.getElementById('kpi-terkirim-comp').textContent = `${(Math.random() > 0.5 ? '+' : '-')}${Math.floor(Math.random()*5)}% vs periode lalu`;
            document.getElementById('kpi-dibayar-comp').textContent = `${(Math.random() > 0.5 ? '+' : '-')}${Math.floor(Math.random()*5)}% vs periode lalu`;
            document.getElementById('kpi-recovery-comp').textContent = `${(Math.random() > 0.5 ? '+' : '-')}${Math.floor(Math.random()*2)}% vs periode lalu`;
            document.getElementById('kpi-contact-comp').textContent = `${(Math.random() > 0.5 ? '+' : '-')}${Math.floor(Math.random()*3)}% vs periode lalu`;

            // 3. Simulasi Data Grafik (Modul E: Grafik Tren Pembayaran)
            const trendDataPaid = [
                Math.floor(Math.random() * 50),
                Math.floor(Math.random() * 50),
                Math.floor(Math.random() * 50),
                Math.floor(Math.random() * 50),
                Math.floor(Math.random() * 50),
                kpi.dibayar // Data bulan ini
            ];
            const trendDataUnpaid = [
                Math.floor(Math.random() * 100),
                Math.floor(Math.random() * 100),
                Math.floor(Math.random() * 100),
                Math.floor(Math.random() * 100),
                Math.floor(Math.random() * 100),
                kpi.terkirim - kpi.dibayar // Data bulan ini
            ];

            paymentTrendChart.data.datasets[0].data = trendDataPaid;
            paymentTrendChart.data.datasets[1].data = trendDataUnpaid;
            paymentTrendChart.update();

            // 4. Simulasi Data Grafik Contact Rate (Modul E: Contact Rate)
            const contactData = [
                Math.floor(Math.random() * kpi.contact), // WA Dibalas
                Math.floor(Math.random() * kpi.contact), // Email Dibalas
                100 - kpi.contact // Tidak Dibalas
            ];
            
            contactRateChart.data.datasets[0].data = contactData;
            contactRateChart.update();

            // 5. Simulasi Data Laporan Harian (Modul E: Laporan Harian)
            dailyReportBody.innerHTML = ''; // Kosongkan
            for (let i = 1; i <= 7; i++) { // 7 hari terakhir
                const dibayar = Math.floor(Math.random() * 20) + 5;
                const terkirim = dibayar + Math.floor(Math.random() * 10);
                const nominal = dibayar * (Math.floor(Math.random() * 1500000) + 500000);
                const recovery = Math.round((dibayar / terkirim) * 100);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">2025-11-0${i}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${terkirim}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-700 font-medium">${dibayar}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold text-right">Rp ${nominal.toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-semibold ${recovery > 75 ? 'text-green-600' : 'text-yellow-600'}">${recovery}%</td>
                `;
                dailyReportBody.appendChild(tr);
            }
        }

        // --- RENDER GRAFIK (Modul E) ---
        function renderPaymentTrendChart() {
            const ctx = document.getElementById('payment-trend-chart').getContext('2d');
            paymentTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November'],
                    datasets: [
                        {
                            label: 'Tagihan Dibayar',
                            data: [0, 0, 0, 0, 0, 0],
                            borderColor: '#22c55e', // green-500
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Tagihan Unpaid/Overdue',
                            data: [0, 0, 0, 0, 0, 0],
                            borderColor: '#ef4444', // red-500
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Jumlah Tagihan' }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    }
                }
            });
        }
        
        function renderContactRateChart() {
            const ctx = document.getElementById('contact-rate-chart').getContext('2d');
            contactRateChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['WA Dibalas', 'Email Dibalas', 'Tidak Dibalas'],
                    datasets: [{
                        label: 'Efektivitas Kontak',
                        data: [0, 0, 100],
                        backgroundColor: [
                            '#25D366', // WhatsApp Green
                            '#4f46e5', // Indigo-600
                            '#e5e7eb'  // gray-200
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // --- HELPER FUNCTIONS ---

        // Untuk Alert
        window.showAlert = (title, message, type = 'info') => {
            const modalScale = alertModal.querySelector('div');
            const iconEl = document.getElementById('alert-icon');
            
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;

            iconEl.classList.remove('text-blue-500', 'text-green-500', 'text-red-500');
            if (type === 'success') {
                iconEl.setAttribute('data-lucide', 'check-circle');
                iconEl.classList.add('text-green-500');
            } else if (type === 'error') {
                iconEl.setAttribute('data-lucide', 'x-circle');
                iconEl.classList.add('text-red-500');
            } else {
                iconEl.setAttribute('data-lucide', 'info');
                iconEl.classList.add('text-blue-500');
            }
            lucide.createIcons(); // Render ulang ikon

            alertModal.classList.add('visible');
            alertModal.classList.remove('hidden');
            setTimeout(() => modalScale.classList.add('scale-100'), 10);
        }

        window.closeAlert = () => {
            const modalScale = alertModal.querySelector('div');
            modalScale.classList.remove('scale-100');
            setTimeout(() => alertModal.classList.add('hidden'), 300);
        }
        
        // Untuk Navigasi Sidebar (Simulasi)
        window.navigate = (page) => {
            showAlert('Simulasi Navigasi', `Anda akan diarahkan ke halaman ${page}.`, 'info');
        }

        // Event listener untuk menutup modal saat klik di luar area
        document.getElementById('alert-modal').addEventListener('click', (e) => {
            if (e.target.id === 'alert-modal') closeAlert();
        });

    </script>
</body>
</html>